name: Login CI

on:
  push:
    branches:
      - staging
      - main
  pull_request:
    branches:
      - staging
      - main

jobs:
  backend-auth-tests:
    name: Backend Auth Tests
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: floginfe
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_URL: jdbc:mysql://127.0.0.1:3306/floginfe?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      DB_USERNAME: root
      DB_PASSWORD: root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Make Maven wrapper executable
        run: chmod +x backend/mvnw

      - name: Run backend Auth-focused tests
        run: |
          cd backend
          ./mvnw -B clean verify -Dtest='*Auth*' -Dit.test='*Auth*'

      - name: Generate backend Jacoco report
        run: |
          cd backend
          ./mvnw -B jacoco:report

      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-auth-coverage
          path: backend/target/site/jacoco
          if-no-files-found: error

  frontend-login-tests:
    name: Frontend Login Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run only Login mock/unit/integration tests
        working-directory: frontend
        env:
          CI: true
        run: npm run test:coverage -- src/tests/LoginTest

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-login-coverage
          path: frontend/coverage
          if-no-files-found: error

  login-e2e:
    name: Cypress Login E2E
    runs-on: ubuntu-latest
    needs:
      - backend-auth-tests
      - frontend-login-tests
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: floginfe
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_URL: jdbc:mysql://127.0.0.1:3306/floginfe?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      DB_USERNAME: root
      DB_PASSWORD: root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Prepare backend artifacts
        run: |
          chmod +x backend/mvnw
          cd backend
          ./mvnw -B clean package -DskipTests

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Start backend API
        run: |
          cd backend
          nohup java -jar target/backend-0.0.1-SNAPSHOT.jar > ../backend.log 2>&1 &

      - name: Start frontend dev server
        run: |
          cd frontend
          nohup npm run dev -- --host 0.0.0.0 --port 5173 > ../frontend-dev.log 2>&1 &

      # FIX: Add a short sleep and increase wait-on timeout to 3 minutes
      - name: Wait for backend and frontend startup
        run: |
          echo "Giving services a moment to spin up before waiting..."
          sleep 5 
          npx --yes wait-on -t 180000 http://127.0.0.1:8080/api/auth/login http://127.0.0.1:5173

      - name: Run Cypress Login E2E test
        working-directory: frontend
        env:
          CYPRESS_baseUrl: http://127.0.0.1:5173
        run: npm run test:e2e -- --spec cypress/e2e/login.e2e.spec.js

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: login-service-logs
          path: |
            backend.log
            frontend-dev.log
          if-no-files-found: ignore